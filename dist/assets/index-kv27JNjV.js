(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const n of t.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function o(s){if(s.ep)return;s.ep=!0;const t=r(s);fetch(s.href,t)}})();const g="https://ВАШ-БЭКЕНД/api/deck ";function c(e,i=document){const r=i.querySelector(e);if(!r)throw new Error(`missing ${e}`);return r}function h(){const e=localStorage.getItem("tarobot_session");if(!e)return null;try{return JSON.parse(e)}catch{return null}}function l(e){e?localStorage.setItem("tarobot_session",JSON.stringify(e)):localStorage.removeItem("tarobot_session")}function b(){var s,t;const e=(s=window.Telegram)==null?void 0:s.WebApp,i=(t=e==null?void 0:e.initDataUnsafe)==null?void 0:t.start_param;if(i&&i.startsWith("spread:")){const n=i.slice(7);if(n==="card_of_day"||n==="three_cards"||n==="love")return n}const o=new URLSearchParams(location.search).get("startapp")||"";if(o.startsWith("spread:")){const n=o.slice(7);if(n==="card_of_day"||n==="three_cards"||n==="love")return n}return"three_cards"}async function p(e,i){const r=await fetch(`${g}${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)});if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}function f(){const e=c("#app");e.innerHTML=`
    <div class="container">
      <div class="header">Таро — WebApp</div>
      <div id="screen"></div>
    </div>
  `;const i=h();i?i.drawn.length<i.total_cards?m(i):u(i):w()}function w(){const e=c("#screen");e.innerHTML=`
    <div class="progress">Начнём с перемешивания колоды</div>
    <div class="hidden-card" id="anim"></div>
    <div style="height:8px"></div>
    <button class="primary" id="btn">Перемешать</button>
  `;const i=c("#anim"),r=c("#btn");r.onclick=async()=>{i.classList.add("spin"),r.disabled=!0;try{if(h()){f();return}const t={spread:b(),allow_reversed:!0,user_id:0},n=await p("/start",t),d={session_id:n.session_id,deck_token:n.deck_token,positions:n.positions,total_cards:n.total_cards,drawn:[]};l(d),f()}catch{r.disabled=!1,i.classList.remove("spin"),alert("Сеть недоступна. Попробуйте позже.")}}}function m(e){const i=c("#screen"),r=`Карта ${e.drawn.length+1} из ${e.total_cards}`;i.innerHTML=`
    <div class="progress">${r}</div>
    <div class="card-list" id="list"></div>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="primary" id="btn">Тянуть карту</button>
      <button id="done" ${e.drawn.length===e.total_cards?"":"disabled"}>Готово</button>
    </div>
  `;const o=c("#list");for(const n of e.drawn){const d=document.createElement("div");d.className="card",d.innerHTML=n.flipped?y(n.index,n.flipped):_(n.index),o.appendChild(d)}const s=c("#btn");s.onclick=async()=>{s.disabled=!0;try{const n=await p("/draw",{session_id:e.session_id,deck_token:e.deck_token});if("done"in n){u(e);return}e.drawn.push({index:n.card_index}),l(e),m(e)}catch{s.disabled=!1,alert("Сеть недоступна. Попробуйте позже.")}};const t=c("#done");t.onclick=()=>u(e)}function u(e){const i=c("#screen"),r=`Карта ${Math.min(e.drawn.length+1,e.total_cards)} из ${e.total_cards}`;i.innerHTML=`
    <div class="progress">${r}</div>
    <div class="card-list" id="list"></div>
    <div style="display:flex; gap:8px; margin-top:8px;">
      <button class="primary" id="finish" ${e.drawn.length===e.total_cards?"":"disabled"}>Готово</button>
    </div>
  `;const o=c("#list");for(const t of e.drawn){const n=document.createElement("div");n.className="card",n.innerHTML=t.flipped?y(t.index,t.flipped):_(t.index),n.onclick=async()=>{if(!t.flipped)try{const d=await p("/flip",{session_id:e.session_id,deck_token:e.deck_token,card_index:t.index});t.flipped=d,l(e),u(e)}catch{alert("Сеть недоступна. Попробуйте позже.")}},o.appendChild(n)}const s=c("#finish");s.onclick=async()=>{var t,n;try{const d=e.drawn.map(v=>({index:v.index,...v.flipped||{}}));await p("/finish",{session_id:e.session_id,deck_token:e.deck_token,drawn:d});const a=(t=window.Telegram)==null?void 0:t.WebApp;try{(n=a==null?void 0:a.sendData)==null||n.call(a,JSON.stringify({ok:!0}))}catch{}l(null),a?a.close():(alert("Готово! Сессию закрыли."),f())}catch{alert("Сеть недоступна. Попробуйте позже.")}}}function _(e){return`<div class="title">Карта #${e+1}</div><div class="meta">закрыта</div>`}function y(e,i){const r=i.reversed?"reversed":"";return`<div><div class="title">${i.name}</div><div class="meta">${i.suit}</div></div><div class="flipped ${r}">⟲</div>`}f();
